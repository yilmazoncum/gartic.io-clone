<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhiteBoard</title>
  </head>
  <style>
    .main-div{
      display: flex;
    }
    #my-canvas {
      border: 2px solid black;
    }
    #bottom-canvas {
      display: grid;
      grid-template-columns: 110px 150px 110px;
      grid-template-rows: 40px;
      grid-column-gap: 10px;
      grid-row-gap: 0px;
    }
    #color-picker-container{
        display: flex;
align-items: center;
    }
    #client-count-container {   
        display: flex;
align-items: center;
    }
  </style>
  <body>
    <div id="question-div">
      <h1 id="question" style="display: none">Default</h1>
    </div>
    <div class="main-div">
      <canvas id="my-canvas"></canvas>
      <div id="user-list-div">
      </div>
    </div>
    <div class="answer-div" id="answer-container">
      <form id="guess-form"action="">
        <input type="text" id="guess-text-field">
        <input type="submit" value="Submit">
    </div>
    <div id="bottom-canvas">
      <div id="color-picker-container" >
        <label for="color">Color : </label>
        <input type="color" id="pen-color" value="#f6b73c" />
      </div>
      <div id="client-count-container">
        <label>Client Count : </label>
        <p id="client-count"> !? </p>
      </div>
      <div id="round-time-container">
        <label>Remaining Time: </label>
        <p id="round-time-left">30</p>
      </div>
    </div>
    <div id="start-button-container">
      <button id="start-round" style="display: none;">Start</button>
      <button id="start-btn"> Start Game</button>
    </div>
  </body>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    var canvas = document.getElementById('my-canvas');
    var colorPicker = document.getElementById('pen-color');
    var clientCount = document.getElementById('client-count');
    var userList = document.getElementById('user-list-div');
    var remainingTime = document.getElementById('round-time-left');
    var mainDiv = document.querySelector(".main-div");
    var startBtn = document.getElementById('start-btn');
    var startRoundBtn = document.getElementById('start-round');//button to start the round
    var questionField = document.getElementById("question");
    var guessField = document.getElementById("guess-text-field");
    var guessForm = document.getElementById("guess-form");
    var answerContainer = document.getElementById("answer-container")


    var username = localStorage.getItem('username');

    var currentAnswer

    canvas.width = 0.6 * window.innerWidth;
    canvas.height = 0.8 * window.innerHeight;

    var io = io();
    var drawer = false;

    io.emit('add username',username);

    let ctx = canvas.getContext('2d');
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    let x,y,penColor;
    let lineActive = false;
    let isDrawing = false;

    //variables for canvas
    let lastX = 0;
    let lastY = 0;
    let hue = 0;
    let lineWidth = 50;
    // ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;

    // canvas.addEventListener('mousedown',(e) => {
    //     if(drawer){
    //       lineActive = !lineActive
    //       ctx.moveTo(x, y)
    //       ctx.beginPath();
    //       io.emit('down',{x,y})
    //     }
    // })

    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mousedown", (event) => {
      if(drawer){
        isDrawing = true;
        [lastX, lastY] = [event.lastX, event.lastY];
        io.emit('down',{lastX,lastY});
      }
    });
    canvas.addEventListener("mouseup", () => isDrawing = false);
    canvas.addEventListener("mouseout", () => isDrawing = false);

    //start the round
    startRoundBtn.addEventListener('click',(e) => {
      console.log(answerContainer);
      io.emit('start-round')
    })

    io.on('round-begun', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      startRoundBtn.disabled = true;
    })

    io.on('change-remaining-time', (data) => {
      remainingTime.textContent = data;
    })

    io.on('drawer', () => {
      
      if(drawer == false){
        guessField.disabled = true
        guessForm.disabled = true
        answerContainer.style.display = 'none'
        drawer = true;
      }
      else{
        drawer = false;
        questionField.style.display = "none"
        answerContainer.style.display = 'block'
      }
      console.log(drawer);
    })

    io.on('onDraw', (data) => {
        drawLine(data);
    })

    io.on('onDown', (data) => {
        lineActive = !lineActive
        ctx.moveTo(data.x, data.y)
        ctx.beginPath();
    })

    io.on('update-client-count', (clientIdArr) =>{
        clientCount.innerHTML = clientIdArr.length
        updateUserList(clientIdArr)
    })
    
    io.on('error',(err) => {
      console.log(mainDiv);
      h = document.createElement('H1')
      t = document.createTextNode(err);
      h.appendChild(t)
      mainDiv.appendChild(h)
    })

    io.on('leaderChange',() => {
      console.log("leaderChange Client");
      startBtn.style.display = "inline"
      io.emit('leaderChange')
    })

    io.on('showQuestion', (q) => {
      questionField.innerHTML = q
      questionField.style.display = "block"
    })

    io.on('game-begun',() => {
      startBtn.style.display = "none";
      startRoundBtn.style.display = "block";
    })

    io.on('setQuestion',(q) => {
      currentAnswer = q
    })

    io.on('round-end', () =>{
      startRoundBtn.disabled = false;
      guessField.disabled = false
      guessForm.disabled = false
      remainingTime.textContent = 0;

      drawer = false;
      lineActive = false;
      isDrawing = false;
      questionField.style.display = "none"
      answerContainer.style.display = 'block'
    })

    io.on('game-end', (results) =>{
        console.log(results)
        localStorage.setItem('resultsArr',JSON.stringify(results));
        window.location.replace("/results")
    })
    
    colorPicker.addEventListener('input', (e) => {
        penColor = colorPicker.value
    })

    startBtn.addEventListener('click', (e) => {
      console.log("startBtn clicked");
      e.preventDefault()
      io.emit("startGame")
    })

    guessForm.addEventListener("submit", (e) => {
      e.preventDefault();   
      console.log("guess : " + guessField.value)
      console.log("currentAnswer : "+ currentAnswer)
      guess = guessField.value
      guessField.value = ""
      if (guess == currentAnswer) {
      guessField.disabled = true
      guessForm.disabled = true
      io.emit('guessCorrect', guess)
      }
      
      

    });

    const drawLine = (data) => {
        ctx.strokeStyle = data.penColor;
        ctx.lineTo(data.x,data.y)
        ctx.stroke();
    }
    
    const updateUserList = (clientArr) =>{
        userList.innerHTML = ""
        clientArr.forEach((element) => {
            var paragraph = document.createElement("p");
            paragraph.textContent = element.username + " -> " + element.correctAnswerCount
            userList.append(paragraph);
        });
    } 
    
    function draw(event){
      if(!isDrawing) return;

      x = event.offsetX;
      y = event.offsetY;

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(event.offsetX, event.offsetY);
      ctx.stroke();
      io.emit("draw",{x,y})

      lastX = event.offsetX
      lastY = event.offsetY
}




  </script>
</html>
