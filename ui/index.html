<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhiteBoard</title>
  </head>
  <style>
    body{
      background-color: antiquewhite;
    }
    .main-div{
      display: flex;
      z-index:5;
    }
    #my-canvas {
      border: 2px solid black;
      z-index:5;
    }
    #bottom-canvas {
      display: grid;
      grid-template-columns: 110px 150px 220px;
      grid-template-rows: 40px;
      grid-column-gap: 10px;
      grid-row-gap: 0px;
      z-index:5;
    }
    #color-picker-container{
        display: flex;
        align-items: center;
        z-index:5;
    }
    #client-count-container {   
        display: flex;
        align-items: center;
        z-index:5;
        font-size: x-large;
    }
    #round-time-container {   
        display: flex;
        align-items: center;
        width: fit-content;
        z-index:5;
        font-size: x-large;
    }
    #user-list-div{
      border: outset rgb(94, 82, 68);
      margin-bottom: 0.3em;
    }
    #my-canvas{
      border: outset rgb(94, 82, 68);
      margin-right: 0.5em;
      margin-bottom: 0.3em;
    }
    #overlayDiv {
    z-index:99;
    height: 100%;
    width: 100%;
    position: fixed;
    text-align: left;
    padding-left: 18%;
    padding-top: 12%;
    font-size: 40px;
    display:none;
    color:black;
    }
  </style>
  <body>
    <div id="overlayDiv">
      <h1 id="overlayH1">DENEME</h1>
      <h3 id="overlayH3">deneme</h3>
    </div>
    <div id="question-div">
      <h1 id="question" style="display: none">Default</h1>
    </div>
    <div class="main-div">
      <canvas id="my-canvas"></canvas>
      <div id="user-list-div">
      </div>
    </div>
    <div class="answer-div" id="answer-container">
      <form id="guess-form"action="">
        <input type="text" id="guess-text-field">
        <input type="submit" value="Submit">
    </div>
    <div id="bottom-canvas">
      <div id="color-picker-container" >
        <label for="color">Color : </label>
        <input type="color" id="pen-color" value="#000000" />
      </div>
      <div id="client-count-container">
        <label>Client Count : </label>
        <p id="client-count"> !? </p>
      </div>
      <div id="round-time-container">
        <label>Remaining Time: </label>
        <p id="round-time-left">30</p>
      </div>
    </div>
    <div id="start-button-container">
      <button id="start-round" style="display: none;">Start</button>
      <button id="start-btn"> Lock the Room</button>
    </div>
    
  </body>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    var canvas = document.getElementById('my-canvas');
    var colorPicker = document.getElementById('pen-color');
    var clientCount = document.getElementById('client-count');
    var userList = document.getElementById('user-list-div');
    var remainingTime = document.getElementById('round-time-left');
    var mainDiv = document.querySelector(".main-div");
    var startBtn = document.getElementById('start-btn');
    var startRoundBtn = document.getElementById('start-round');//button to start the round
    var questionField = document.getElementById("question");
    var guessField = document.getElementById("guess-text-field");
    var guessForm = document.getElementById("guess-form");
    var answerContainer = document.getElementById("answer-container")

    var username = localStorage.getItem('username');
    

    var currentAnswer
    

    canvas.width = 0.6 * window.innerWidth;
    canvas.height = 0.8 * window.innerHeight;

    var io = io();
    var isDrawer = false;
     
     
    document.title = username;
    io.emit('add username',username);

    let ctx = canvas.getContext('2d');
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    let x,y,penColor;
    let lineActive = false;
    let isDrawing = false;

    //variables for canvas
    let lastX = 0;
    let lastY = 0;
    let hue = 0;
    let lineWidth = 50;
    // ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;

    // canvas.addEventListener('mousedown',(e) => {
    //     if(drawer){
    //       lineActive = !lineActive
    //       ctx.moveTo(x, y)
    //       ctx.beginPath();
    //       io.emit('down',{x,y})
    //     }
    // })

    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mousedown", (event) => {
      if(isDrawer){
        isDrawing = true;
        [lastX, lastY] = [event.lastX, event.lastY];
        io.emit('down',{lastX,lastY});
      }
    });
    canvas.addEventListener("mouseup", () => isDrawing = false);
    canvas.addEventListener("mouseout", () => isDrawing = false);

    //start the round
    startRoundBtn.addEventListener('click',(e) => {
      console.log(answerContainer);
      io.emit('start-round')
    })

    io.on('round-begun', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      startRoundBtn.disabled = true;
      if(isDrawer == false) {
      OverlayControl("Tahmin Zamanı !","#9400D3");
      }
    })

    io.on('change-remaining-time', (data) => {
      remainingTime.textContent = data;
    })

    io.on('drawer', () => {
      
      if(isDrawer == false){
        //Drawer olan kişi
        OverlayControl("Sıra Sende !","#E55132")
        guessField.disabled = true
        guessForm.disabled = true
        answerContainer.style.display = 'none'
        isDrawer = true;
      }
      else{
        isDrawer = false;
        questionField.style.display = "none"
        answerContainer.style.display = 'block'
      }
      console.log(isDrawer);
    })

    io.on('onDraw', (data) => {
        drawLine(data);
    })

    io.on('onDown', (data) => {
        lineActive = !lineActive
        ctx.moveTo(data.x, data.y)
        ctx.beginPath();
    })

    io.on('update-client-count', (clientIdArr) =>{
        clientCount.innerHTML = clientIdArr.length
        updateUserList(clientIdArr)
    })
    
    io.on('error',(err) => {
      console.log(mainDiv);
      h = document.createElement('H1')
      t = document.createTextNode(err);
      h.appendChild(t)
      mainDiv.appendChild(h)
    })

    io.on('leaderChange',() => {
      console.log("leaderChange Client");
      startBtn.style.display = "inline"
      io.emit('leaderChange')
    })

    io.on('showQuestion', (q) => {
      questionField.innerHTML = q
      questionField.style.display = "block"
    })

    io.on('game-begun',() => {
      startBtn.style.display = "none";
      
      OverlayControl("Oda Hazır Oyun Başlayacak !","#327DE5");      
      
    })

    io.on('prepare-drawer',() => {
      startRoundBtn.style.display = "block";
      OverlayControl("Sıra Sende !","#E55132")
    })

    io.on('setQuestion',(q) => {
      currentAnswer = q
    })

    io.on('round-end', (reason) =>{
      
      startRoundBtn.disabled = false;
      startRoundBtn.style.display = "none";
      guessField.disabled = false
      guessForm.disabled = false
      remainingTime.textContent = 0;

      isDrawer = false;
      lineActive = false;
      isDrawing = false;
      questionField.style.display = "none"
      answerContainer.style.display = 'block'

      if(reason == "time"){
      OverlayControl("Süre Bitti !","#E5D332")
      }
      else if(reason == "correct"){
      OverlayControl("Herkes doğru cevap verdi","#48E532")
      }
      guessField.style.backgroundColor = "white";

      io.emit('prepare-next-drawer');
    })

    io.on('game-end', (results) =>{
        console.log(results)
        localStorage.setItem('resultsArr',JSON.stringify(results));
        window.location.replace("/results")
    })

    io.on('highscore-info', (str)=>{
    console.log("264" + str)
    StartingOverlay(str);
    })
    
    colorPicker.addEventListener('input', (e) => {
        penColor = colorPicker.value
    })

    startBtn.addEventListener('click', (e) => {
      console.log("startBtn clicked");
      e.preventDefault()
      io.emit("startGame")
    })

    guessForm.addEventListener("submit", (e) => {
      e.preventDefault();   
      console.log("guess : " + guessField.value)
      console.log("currentAnswer : "+ currentAnswer)
      guess = guessField.value
      guessField.value = ""
      if (guess == currentAnswer) {
      guessField.disabled = true
      guessForm.disabled = true
      guessField.style.backgroundColor = "#48E532";
      io.emit('guessCorrect', guess)
      }
      
      

    });

    const drawLine = (data) => {
        ctx.strokeStyle = data.penColor;
        ctx.lineTo(data.x,data.y)
        ctx.stroke();
    }
    
    const updateUserList = (clientArr) =>{
        userList.innerHTML = ""
        clientArr.forEach((element) => {
            var paragraph = document.createElement("p");
            paragraph.textContent = element.username + " -> " + element.point
            paragraph.style.borderStyle = "outset";
            paragraph.style.borderColor = "#573b39";
            paragraph.style.fontSize = "x-large";
            paragraph.style.marginTop = "0em";
            paragraph.style.marginBottom = "0.2em";
            paragraph.style.padding = "0.1em 1em";
            paragraph.style.width = "auto";
            paragraph.style.alignContent = "center";
            console.log("element"+element.point);
            userList.append(paragraph);
        });
    } 
    
    function draw(event){
      if(!isDrawing) return;

      x = event.offsetX;
      y = event.offsetY;

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(event.offsetX, event.offsetY);
      if(isDrawer == true){     
      ctx.strokeStyle = penColor;
      ctx.stroke();
      io.emit("draw",{x,y,penColor})
      }
      else{
      ctx.strokeStyle = event.penColor;
      ctx.stroke();
      io.emit("draw",{x,y,penColor})
      }
      

      lastX = event.offsetX
      lastY = event.offsetY
    }

    function OverlayControl(text,color){
      document.getElementById("overlayDiv").style.display = "block";
      document.getElementById("overlayDiv").style.color = color;
      document.getElementById("overlayH1").innerHTML = text;
      setTimeout( () => {
        document.getElementById("overlayDiv").style.display = "none";
        document.getElementById("overlayDiv").style.zIndex = 0;
        console.log(document.getElementById("overlayDiv").style.zIndex)
        
      }, 3000);
    }

    function StartingOverlay(str){ 
      document.getElementById("overlayDiv").style.display = "block";
      document.getElementById("overlayDiv").style.color = "#32E5D5";
      document.getElementById("overlayH1").innerHTML = "Hoşgeldiniz";
      console.log(document.getElementById("overlayH3"));
      document.getElementById("overlayH3").innerHTML = str;

      setTimeout( () => {
        document.getElementById("overlayDiv").style.display = "none";
        document.getElementById("overlayDiv").style.zIndex = 0;
      }, 3000);
    }




  </script>
</html>
